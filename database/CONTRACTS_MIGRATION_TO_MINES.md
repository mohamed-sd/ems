# تحديث نظام العقود - الربط بالمناجم بدلاً من المشاريع

## التاريخ: 2026-02-03

## ملخص التغييرات

تم تحويل نظام العقود من الربط المباشر بالمشاريع إلى الربط بالمناجم. كل عقد الآن مرتبط بمنجم محدد داخل المشروع.

## التعديلات المنفذة

### 1. قاعدة البيانات
- **الملف**: `database/equipation_manage.sql`
- **التغيير**: تم تغيير حقل `project` إلى `mine_id` في جدول `contracts`
- **النوع**: `INT(250) NOT NULL COMMENT 'معرف المنجم من جدول mines'`

### 2. سكريبت الترحيل
- **الملف**: `database/migrate_contracts_to_mines.sql`
- **الوظيفة**: سكريبت SQL شامل لترحيل البيانات الموجودة من project إلى mine_id
- **الخطوات**:
  1. إضافة حقل `mine_id` الجديد
  2. ربط العقود بأول منجم في كل مشروع
  3. حذف حقل `project` القديم
  4. إضافة مفتاح خارجي (Foreign Key)
  5. إنشاء فهرس للأداء

### 3. ملفات العقود

#### `Contracts/contracts.php`
- تغيير متغير `$project` إلى `$mine_id`
- تحديث استعلام INSERT لاستخدام `mine_id`
- تحديث استعلام SELECT مع JOIN لجدول `mines` و `project`
- تحديث حقل النموذج المخفي من `project` إلى `mine_id`
- عرض بيانات المنجم والمشروع معاً

#### `Contracts/contracts_details.php`
- تحديث استعلام SELECT الرئيسي للانضمام مع جداول `mines` و `project`
- تغيير عرض "معلومات المشروع" إلى "معلومات المنجم"
- عرض: اسم المنجم + رمز المنجم + اسم المشروع
- تغيير المتغير من `$project_id` إلى `$mine_id`
- تحديث استعلام دمج العقود لنفس المنجم

#### `Contracts/contract_actions_handler.php`
- تحديث التحقق من عملية الدمج: "لا يمكن دمج عقود من مناجم مختلفة"
- تغيير الشرط من `project` إلى `mine_id`

### 4. ملفات التقارير

#### `Reports/contract_report.php`
- تحديث استعلامات بيانات العقد مع LEFT JOIN لـ `mines` و `project`
- إضافة حقول: `mine_name`, `mine_code`, `project_name`
- تحديث الإحصائية الشهرية لاستخدام نفس النمط

### 5. ملفات المناجم

#### `Projects/project_mines.php`
- تحديث استعلام عدد العقود: `WHERE mine_id = ...`
- تغيير نص التلميح من "عرض عقود المشروع" إلى "عرض عقود المنجم"

## البنية الجديدة

### العلاقات
```
project (المشروع)
  └── mines (المناجم)
        └── contracts (العقود)
              └── contractequipments (معدات العقد)
```

### الاستعلام النموذجي
```sql
SELECT c.*, m.mine_name, m.mine_code, p.name AS project_name
FROM contracts c
LEFT JOIN mines m ON c.mine_id = m.id
LEFT JOIN project p ON m.project_id = p.id
WHERE c.mine_id = $mine_id
```

## خطوات التطبيق

1. **النسخ الاحتياطي**: احفظ نسخة من قاعدة البيانات
2. **تنفيذ الترحيل**: قم بتشغيل `database/migrate_contracts_to_mines.sql`
3. **التحقق**: تأكد من ربط جميع العقود بالمناجم الصحيحة
4. **الاختبار**: اختبر:
   - إضافة عقد جديد
   - عرض تفاصيل العقد
   - تقارير العقود
   - دمج العقود (يجب أن يكون للمنجم نفسه فقط)

## ملاحظات مهمة

- ✅ العقود الآن مرتبطة بالمناجم وليس المشاريع مباشرة
- ✅ يمكن الوصول للمشروع من خلال المنجم (`mine_id` → `project_id`)
- ✅ دمج العقود يتطلب أن يكونوا في نفس المنجم
- ✅ عرض بيانات المنجم والمشروع معاً في صفحات العقود
- ⚠️ تأكد من وجود منجم واحد على الأقل لكل مشروع قبل إضافة عقود
- ⚠️ إذا كان لمشروع أكثر من منجم، راجع سكريبت الترحيل (الخطوة 2) لتحديد الربط الصحيح

## الملفات المتأثرة

```
database/
  ├── equipation_manage.sql (محدّث)
  └── migrate_contracts_to_mines.sql (جديد)

Contracts/
  ├── contracts.php (محدّث)
  ├── contracts_details.php (محدّث)
  └── contract_actions_handler.php (محدّث)

Reports/
  └── contract_report.php (محدّث)

Projects/
  └── project_mines.php (محدّث)
```

## الدعم والمساعدة

في حالة وجود مشاكل:
1. تحقق من تنفيذ سكريبت الترحيل بنجاح
2. تأكد من وجود بيانات في جدول `mines`
3. راجع ملفات الخطأ (error logs)
4. تحقق من العلاقات بين الجداول (Foreign Keys)
