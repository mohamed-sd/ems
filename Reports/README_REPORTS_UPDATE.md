# تحديث نظام التقارير - إضافة المناجم والعقود

## التحديثات المنفذة

### 1. تحديث صفحة التقارير (reports.php)

#### التحسينات في SQL Query:
- إضافة LEFT JOIN مع جدول `mines` لإظهار بيانات المناجم
- إضافة LEFT JOIN مع جدول `contracts` لإظهار بيانات العقود
- إضافة شروط فلترة للمناجم والعقود
- تحسين GROUP BY ليشمل المنجم والعقد

#### تحسينات الفلترة:
- إضافة فلتر المنجم (4 فلاتر الآن: مورد، مشروع، منجم، عقد)
- تصميم محسّن مع أيقونات Font Awesome
- زر إعادة تعيين الفلتر
- تحميل ديناميكي للمناجم عند اختيار المشروع
- تحميل ديناميكي للعقود عند اختيار المنجم

#### تحسينات الجدول:
- إضافة أعمدة: المشروع، المنجم، العقد، المورد، إجمالي الساعات
- ترقيم تلقائي للصفوف
- عرض "غير محدد" للقيم الفارغة
- تنسيق أفضل للبيانات مع badges وألوان

### 2. إنشاء AJAX Endpoints

#### get_project_mines.php
- يستقبل معرف المشروع (project_id)
- يرجع قائمة JSON بالمناجم المرتبطة بالمشروع
- يتحقق من الصلاحيات

#### get_mine_contracts.php
- يستقبل معرف المنجم (mine_id)
- يرجع قائمة JSON بالعقود المرتبطة بالمنجم
- يعرض تاريخ التوقيع وتواريخ البداية والنهاية

### 3. JavaScript المحسّن

#### Cascading Dropdowns:
- عند اختيار مشروع → يتم تحميل مناجمه تلقائياً
- عند اختيار منجم → يتم تحميل عقوده تلقائياً
- إعادة تعيين القوائم التابعة عند تغيير القيمة الأساسية

## هيكل البيانات الجديد

```
project (مشروع)
  ├── mines (مناجم)
  │   ├── mine 1
  │   │   ├── contract 1
  │   │   ├── contract 2
  │   │   └── ...
  │   ├── mine 2
  │   │   └── contracts...
  │   └── ...
  └── suppliers (موردين)
      └── equipment (معدات)
          └── operations (تشغيل)
              └── timesheet (ساعات عمل)
```

## طريقة الاستخدام

1. **عرض جميع التقارير**: افتح الصفحة بدون فلاتر
2. **الفلترة**:
   - اختر المورد (اختياري)
   - اختر المشروع → ستظهر مناجمه
   - اختر المنجم → ستظهر عقوده
   - اختر العقد (اختياري)
   - اضغط "تطبيق الفلتر"
3. **التصدير**: استخدم أزرار DataTables للتصدير (Excel, PDF, CSV, Print)

## الملفات المعدلة

- `Reports/reports.php` - الصفحة الرئيسية للتقارير
- `Reports/get_project_mines.php` - AJAX endpoint للمناجم
- `Reports/get_mine_contracts.php` - AJAX endpoint للعقود

## متطلبات التشغيل

- PHP 5.6+
- MySQL/MariaDB
- jQuery 3.7.1
- DataTables 1.13.6
- Bootstrap 5
- Font Awesome 6

## ملاحظات

- جميع الاستعلامات تستخدم mysqli_real_escape_string للحماية من SQL Injection
- التحقق من صلاحيات المستخدم في جميع الملفات
- معالجة القيم الفارغة بشكل صحيح (NULL handling)
- تنسيق JSON responses بشكل موحد

## تاريخ التحديث

17 فبراير 2026
