# نظام إدارة المناجم - EMS

## نظرة عامة
تم إضافة نظام شامل لإدارة المناجم المرتبطة بالمشاريع، حيث يمكن لكل مشروع أن يحتوي على منجم أو مجموعة من المناجم.

## البنية التقنية

### 1. جدول قاعدة البيانات (mines)

**الحقول الأساسية:**
- `id` - المعرف الفريد
- `project_id` - معرف المشروع (Foreign Key إلى company_project)
- `mine_name` - اسم المنجم
- `mine_code` - كود/رمز المنجم (فريد - UNIQUE)
- `manager_name` - اسم مدير المنجم

**معلومات المنجم:**
- `mineral_type` - نوع المعدن (ذهب، فضة، نحاس، إلخ)
- `mine_type` - نوع المنجم:
  * حفرة مفتوحة
  * تحت أرضي
  * آبار
  * مهجور
  * مجمع معالجة/تركيز
  * موقع تخزين/مستودع
  * أخرى (مع حقل تفصيلي)

**الملكية والتعاقد:**
- `ownership_type` - نوع الملكية:
  * تعدين أهلي/تقليدي
  * شركة سودانية خاصة
  * شركة حكومية/قطاع عام
  * شركة أجنبية
  * مشروع مشترك (سوداني-أجنبي)
  * أخرى (مع حقل تفصيلي)

- `contract_nature` - طبيعة التعاقد:
  * موظف مباشر لدى المالك
  * مقاول/شركة مقاولات

**المقاييس:**
- `mine_area` - مساحة المنجم (رقم عشري)
- `mine_area_unit` - وحدة القياس (هكتار / كم²)
- `mining_depth` - عمق التعدين (متر)

**إدارة البيانات:**
- `status` - حالة المنجم (1=نشط، 0=غير نشط)
- `notes` - ملاحظات إضافية
- `created_by` - معرف المستخدم الذي أضاف السجل
- `created_at` - تاريخ الإضافة
- `updated_at` - تاريخ آخر تحديث

### 2. الملفات المُنشأة

#### `database/create_project_mines_table.sql`
سكريبت SQL لإنشاء جدول المناجم مع جميع الحقول والفهارس.

**خطوات التطبيق:**
```sql
-- تنفيذ في phpMyAdmin
USE equipation_manage;
SOURCE database/create_project_mines_table.sql;
```

#### `Projects/project_mines.php`
صفحة إدارة المناجم الكاملة مع:
- واجهة حديثة متجاوبة
- عرض بيانات المشروع
- جدول بيانات تفاعلي (DataTables)
- نماذج إضافة/تعديل عبر Modal
- حذف مع تأكيد
- حقول شرطية (تظهر عند اختيار "أخرى")
- رسائل نجاح/فشل تفاعلية
- تنسيق عربي كامل

### 3. التعديلات على الملفات الموجودة

#### `Projects/view_projects.php`
- إضافة زر "إدارة المناجم" في صفحة عرض تفاصيل المشروع
- إضافة حقل مخفي `view_project_id` لحفظ معرف المشروع
- حفظ المعرف عند عرض تفاصيل المشروع
- الزر ينقل مباشرة لصفحة المناجم مع معرف المشروع

## سير العمل

### إضافة منجم جديد:
1. الدخول للمشروع من صفحة المشاريع
2. الضغط على زر "عرض التفاصيل"
3. الضغط على زر "إدارة المناجم"
4. الضغط على "إضافة منجم جديد"
5. ملء البيانات المطلوبة:
   - كود المنجم (مطلوب - فريد)
   - اسم المنجم (مطلوب)
   - اسم المدير (اختياري)
   - نوع المعدن (اختياري)
   - نوع المنجم (مطلوب)
   - نوع الملكية (مطلوب)
   - المساحة والعمق (اختياري)
   - طبيعة التعاقد (اختياري)
   - الحالة (مطلوب)
   - ملاحظات (اختياري)
6. حفظ البيانات

### تعديل منجم:
1. من جدول المناجم، الضغط على زر "تعديل"
2. تظهر نافذة بالبيانات الحالية
3. تعديل البيانات المطلوبة
4. حفظ التغييرات

### حذف منجم:
1. الضغط على زر "حذف"
2. تأكيد الحذف
3. يتم حذف المنجم نهائياً

## الميزات التقنية

### 1. التحقق من البيانات
- **كود المنجم:** فريد على مستوى النظام (UNIQUE constraint)
- **الحقول المطلوبة:** التحقق في الواجهة وقاعدة البيانات
- **الأرقام العشرية:** دعم القيم العشرية للمساحة والعمق

### 2. الحقول الشرطية
- عند اختيار "أخرى" في نوع المنجم → يظهر حقل تفصيلي
- عند اختيار "أخرى" في نوع الملكية → يظهر حقل تفصيلي
- يتم إخفاء/إظهار الحقول تلقائياً بواسطة JavaScript

### 3. التنسيق والعرض
- **المساحة:** عرض مع وحدة القياس (هكتار/كم²)
- **العمق:** عرض بالمتر مع تنسيق الأرقام
- **الحالة:** عرض ملون (أخضر للنشط، أحمر لغير النشط)
- **الجدول:** قابل للفرز والبحث والترتيب (DataTables)

### 4. AJAX والتفاعلية
- إضافة/تعديل بدون إعادة تحميل الصفحة
- رسائل نجاح/فشل فورية
- تحديث تلقائي بعد الحفظ
- Modal متحرك مع animation

### 5. الأمان
- `mysqli_real_escape_string()` لجميع المدخلات
- التحقق من الصلاحيات (role = 1 أو -1)
- التحقق من وجود المشروع قبل العرض
- منع SQL Injection

## العلاقات مع الجداول الأخرى

```
company_project (المشاريع الرئيسية)
    ↓ (project_id)
project_mines (المناجم)
    ↓ (created_by)
users (المستخدمين)
```

## استعلامات SQL شائعة

### عرض جميع مناجم مشروع معين:
```sql
SELECT * FROM mines 
WHERE project_id = ? AND status = 1
ORDER BY created_at DESC;
```

### عرض إحصائيات المناجم:
```sql
SELECT 
    mine_type,
    COUNT(*) as count,
    AVG(mine_area) as avg_area,
    AVG(mining_depth) as avg_depth
FROM mines 
WHERE status = 1
GROUP BY mine_type;
```

### البحث عن منجم بالكود:
```sql
SELECT pm.*, cp.project_name 
FROM mines pm
JOIN company_project cp ON pm.project_id = cp.id
WHERE pm.mine_code = ?
LIMIT 1;
```

### عرض المناجم مع بيانات المشروع:
```sql
SELECT 
    pm.*,
    cp.project_name,
    cp.project_code,
    cp.state,
    cp.region
FROM mines pm
INNER JOIN company_project cp ON pm.project_id = cp.id
WHERE pm.status = 1;
```

## التوسعات المستقبلية المقترحة

1. **الإنتاج:** إضافة جدول لتتبع إنتاج كل منجم (كمية، تاريخ، نوع المعدن)
2. **التراخيص:** إدارة تراخيص التعدين (رقم الترخيص، تاريخ الانتهاء، الجهة المانحة)
3. **العمالة:** تتبع عدد العمال في كل منجم (دائم، مؤقت، مقاول)
4. **المعدات:** ربط المعدات بالمناجم المحددة
5. **التقارير:** تقارير الإنتاج والتكاليف لكل منجم
6. **الخرائط:** عرض المناجم على خريطة تفاعلية (Google Maps/Leaflet)
7. **الصور:** إضافة معرض صور لكل منجم
8. **المستندات:** إرفاق مستندات (التراخيص، الدراسات، العقود)

## الاختبار

### سيناريوهات الاختبار:
- [ ] إضافة منجم بكافة الحقول
- [ ] إضافة منجم بالحقول المطلوبة فقط
- [ ] محاولة إضافة منجم بكود مكرر (يجب أن يفشل)
- [ ] تعديل بيانات منجم موجود
- [ ] تعديل كود منجم لكود آخر موجود (يجب أن يفشل)
- [ ] حذف منجم
- [ ] البحث والفرز في جدول المناجم
- [ ] عرض المناجم لمشروع معين
- [ ] اختبار الحقول الشرطية (أخرى)
- [ ] التحقق من الصلاحيات

## الملاحظات

- يجب تشغيل السكريبت SQL قبل استخدام النظام
- كود المنجم يجب أن يكون فريداً على مستوى جميع المناجم (وليس فقط على مستوى المشروع)
- الحقول الرقمية (المساحة والعمق) تقبل NULL
- يمكن إضافة صور ومستندات للمناجم في المستقبل
- النظام يدعم العربية بالكامل (RTL)

## الدعم الفني

للاستفسارات أو المشاكل:
1. التحقق من تشغيل السكريبت SQL بنجاح
2. مراجعة صلاحيات المستخدم
3. التحقق من اتصال قاعدة البيانات
4. مراجعة console المتصفح للأخطاء JavaScript
