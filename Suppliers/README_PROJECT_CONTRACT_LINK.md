# تحديث نظام عقود الموردين - ربط بعقد محدد

## المشكلة السابقة
كان النظام يجلب بيانات **جميع عقود المشروع** معاً، بينما الواقع هو أن المورد يتعاقد على **عقد محدد** من عقود المشروع.

## الحل المطبق

### 1. تعديلات قاعدة البيانات
- إضافة حقل `project_contract_id` إلى جدول `supplierscontracts` للإشارة إلى عقد محدد من جدول `contracts`
- ملف SQL: `database/add_project_contract_id_to_supplierscontracts.sql`

**خطوات التطبيق:**
```sql
-- تنفيذ السكريبت في phpMyAdmin
ALTER TABLE `supplierscontracts` 
ADD COLUMN `project_contract_id` INT(11) DEFAULT NULL COMMENT 'معرف عقد المشروع من جدول contracts' AFTER `project_id`,
ADD INDEX `idx_project_contract` (`project_contract_id`);
```

### 2. ملفات جديدة

#### `Suppliers/get_project_contracts.php`
- يجلب قائمة عقود المشروع المحدد
- يعرض معلومات العقد (التاريخ، الساعات)

### 3. التعديلات على الملفات الموجودة

#### `Suppliers/get_project_hours.php`
**قبل:**
- كان يجلب مجموع ساعات **كل عقود المشروع**
- يحسب مجموع ساعات **كل موردي المشروع**

**بعد:**
- يجلب ساعات **عقد محدد** فقط (`project_contract_id`)
- يحسب ساعات الموردين **للعقد المحدد فقط**
- يستثني عقد المورد الحالي عند التعديل

#### `Suppliers/supplierscontracts.php`

**تغييرات الواجهة:**
1. إضافة dropdown جديد لاختيار العقد من عقود المشروع
2. تحديث النصوص من "ساعات المشروع" إلى "ساعات العقد"

**تغييرات JavaScript:**
1. عند اختيار مشروع → تحميل عقود هذا المشروع
2. عند اختيار عقد → عرض بيانات الساعات للعقد المحدد
3. عند التعديل → تحميل المشروع والعقد المرتبطين

**تغييرات PHP:**
1. إضافة `project_contract_id` لعمليات INSERT/UPDATE
2. إضافة الحقل في بيانات التعديل (data attributes)

### 4. سير العمل الجديد

#### إضافة عقد مورد جديد:
1. اختيار المورد
2. اختيار المشروع → يتم تحميل عقود المشروع
3. اختيار العقد المحدد → يتم عرض:
   - إجمالي ساعات العقد
   - المتعاقد عليه مع موردين آخرين
   - الساعات المتبقية
4. إدخال بيانات عقد المورد
5. الحفظ

#### تعديل عقد مورد:
1. الضغط على زر التعديل
2. يتم تحميل المشروع تلقائياً
3. يتم تحميل عقود المشروع واختيار العقد المرتبط
4. يتم عرض بيانات الساعات (مع استثناء العقد الحالي من الحسابات)

### 5. العلاقات في قاعدة البيانات

```
contracts (عقود المشاريع الرئيسية)
    ↓ (project_contract_id)
supplierscontracts (عقود الموردين)
    ↓ (supplier_id)
suppliers (الموردين)

operationproject (المشاريع)
    ↓ (project field)
contracts
```

### 6. الحسابات الدقيقة

**إجمالي ساعات العقد:**
```sql
SELECT forecasted_contracted_hours 
FROM contracts 
WHERE id = $project_contract_id
```

**المتعاقد عليه مع الموردين:**
```sql
SELECT SUM(forecasted_contracted_hours)
FROM supplierscontracts 
WHERE project_contract_id = $project_contract_id
AND id != $current_supplier_contract_id  -- استثناء العقد الحالي عند التعديل
```

**الساعات المتبقية:**
```
= إجمالي ساعات العقد - المتعاقد عليه مع الموردين
```

### 7. ملاحظات مهمة

- يجب تشغيل السكريبت SQL أولاً قبل استخدام النظام المحدث
- العقود القديمة الموجودة حالياً تحتاج تحديث يدوي لحقل `project_contract_id`
- إذا كان هناك عقد واحد فقط لكل مشروع، يمكن عمل سكريبت لملء الحقل تلقائياً

### 8. اختبار الوظائف

- [x] إضافة عقد مورد جديد
- [x] تعديل عقد مورد موجود
- [x] عرض ساعات العقد بدقة
- [x] استثناء العقد الحالي عند التعديل
- [x] عرض تفصيل المعدات حسب العقد المحدد
