# ุชุญุฏูุซ ูุธุงู ุงููุณุชุฎุฏููู - ุฅุถุงูุฉ ุงูููุงุฌู ูุงูุนููุฏ ููุฏูุฑ ุงููููุน

## ุงูุชุญุฏูุซุงุช ุงููููุฐุฉ - 17 ูุจุฑุงูุฑ 2026

### 1. ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ููู:** `database/add_mine_contract_to_users.sql`

ุฅุถุงูุฉ ุญูููู ุฌุฏูุฏูู ูุฌุฏูู `users`:
- `mine_id` - ูุนุฑู ุงูููุฌู (INT, DEFAULT 0)
- `contract_id` - ูุนุฑู ุงูุนูุฏ (INT, DEFAULT 0)

**ุงูููุงุฑุณ ุงููุถุงูุฉ:**
- `idx_mine_id` - ููุฑุณ ุนูู mine_id
- `idx_contract_id` - ููุฑุณ ุนูู contract_id

**ุชูููุฐ SQL:**
```sql
-- ูู ุจุชูููุฐ ูุฐุง ุงูููู ูู phpMyAdmin
source c:\xamppnew\htdocs\emstest\database\add_mine_contract_to_users.sql
```

### 2. ุชุญุฏูุซ ุตูุญุฉ ุงููุณุชุฎุฏููู

**ููู:** `main/users.php`

#### ุงูุชุบููุฑุงุช ูู PHP:
1. **ูุนุงูุฌุฉ POST:** ุฅุถุงูุฉ `$mine` ู `$contract` ุนูุฏ ุงูุญูุธ/ุงูุชุนุฏูู
2. **SQL INSERT:** ุชุถููู `mine_id, contract_id` ูู ุงูุฅุฏุฑุงุฌ
3. **SQL UPDATE:** ุชุถููู `mine_id='$mine', contract_id='$contract'` ูู ุงูุชุญุฏูุซ
4. **SQL SELECT:** ุฅุถุงูุฉ `mine_id, contract_id` ูู ุงูุงุณุชุนูุงู
5. **ุนุฑุถ ุงูุจูุงูุงุช:** ุฅุถุงูุฉ ุนุฑุถ ุงููุดุฑูุน ูุงูููุฌู ูุงูุนูุฏ ูู ุงูุฌุฏูู

#### ุงูุชุบููุฑุงุช ูู HTML:
ุฅุถุงูุฉ ุญูููู ุฌุฏูุฏูู ูู ุงููููุฐุฌ:
- **ุญูู ุงูููุฌู:** `<select id="mine_id">` - ูุชู ุชุญูููู ุจุนุฏ ุงุฎุชูุงุฑ ุงููุดุฑูุน
- **ุญูู ุงูุนูุฏ:** `<select id="contract_id">` - ูุชู ุชุญูููู ุจุนุฏ ุงุฎุชูุงุฑ ุงูููุฌู

#### ุงูุชุบููุฑุงุช ูู JavaScript:
1. **ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูุญููู:** ุนูุฏ ุงุฎุชูุงุฑ "ูุฏูุฑ ูููุน" ุชุธูุฑ 3 ุญููู (ูุดุฑูุนุ ููุฌูุ ุนูุฏ)
2. **Cascading Dropdowns:**
   - ุงุฎุชูุงุฑ ุงููุดุฑูุน โ ูุญูู ุงูููุงุฌู ุนุจุฑ `fetch()`
   - ุงุฎุชูุงุฑ ุงูููุฌู โ ูุญูู ุงูุนููุฏ ุนุจุฑ `fetch()`
3. **ุงูุชุนุฏูู:** ุชุญููู ุงูููู ุงูุญุงููุฉ ูุน ูุนุงูุฌุฉ ุงูุชูููุช ุงูุตุญูุญ

### 3. AJAX Endpoints ุงูุฌุฏูุฏุฉ

#### `Projects/get_project_mines_ajax.php`
**ุงูุบุฑุถ:** ุฌูุจ ูุงุฆูุฉ ุงูููุงุฌู ููุดุฑูุน ูุนูู

**ุงููุฏุฎูุงุช:**
- `project_id` (GET parameter)

**ุงููุฎุฑุฌุงุช:**
```json
{
  "success": true,
  "mines": [
    {
      "id": 1,
      "mine_name": "ููุฌู ุงูุฐูุจ",
      "mine_code": "MN001"
    }
  ],
  "count": 1
}
```

#### `Contracts/get_mine_contracts_ajax.php`
**ุงูุบุฑุถ:** ุฌูุจ ูุงุฆูุฉ ุงูุนููุฏ ูููุฌู ูุนูู

**ุงููุฏุฎูุงุช:**
- `mine_id` (GET parameter)

**ุงููุฎุฑุฌุงุช:**
```json
{
  "success": true,
  "contracts": [
    {
      "id": 1,
      "contract_signing_date": "2026-02-01",
      "actual_start": "2026-02-04",
      "actual_end": "2026-03-04"
    }
  ],
  "count": 1
}
```

## ุณูุฑ ุงูุนูู ุงูุฌุฏูุฏ

### ุฅุถุงูุฉ ูุฏูุฑ ูููุน:
1. ุงุฎุชุฑ "ูุฏูุฑ ูููุน" ูู ูุงุฆูุฉ ุงูุตูุงุญูุฉ
2. ูุธูุฑ ุญูู **ุงููุดุฑูุน** (ูุทููุจ โญ)
3. ุงุฎุชุฑ ุงููุดุฑูุน โ ุชุญููู ูุงุฆูุฉ **ุงูููุงุฌู** ุชููุงุฆูุงู
4. ุงุฎุชุฑ ุงูููุฌู โ ุชุญููู ูุงุฆูุฉ **ุงูุนููุฏ** ุชููุงุฆูุงู
5. ุงุฎุชุฑ ุงูุนูุฏ
6. ุงููุฃ ุจุงูู ุงูุจูุงูุงุช ูุฃุญูุธ

### ุนุฑุถ ุงูุจูุงูุงุช:
ุนูุฏ ุนุฑุถ ูุฏูุฑ ูููุน ูู ุงูุฌุฏููุ ูุธูุฑ:
```
๐ค ุฃุญูุฏ ูุญูุฏ
   ๐ ูุดุฑูุน ุงูุฑูุณูุฑุณ (PRJ-001)
   โฐ๏ธ ููุฌู ุงูุฐูุจ (MN001)
   ๐ ุนูุฏ #1 - 2026-02-01
```

### ุงูุชุนุฏูู:
- ุนูุฏ ุงูุถุบุท ุนูู ุชุนุฏููุ ูุชู ุชุญููู:
  1. ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุฃุณุงุณูุฉ
  2. ุงููุดุฑูุน ุงููุญุฏุฏ
  3. ูุงุฆูุฉ ุงูููุงุฌู ูููุดุฑูุน โ ุชุญุฏูุฏ ุงูููุฌู
  4. ูุงุฆูุฉ ุงูุนููุฏ ููููุฌู โ ุชุญุฏูุฏ ุงูุนูุฏ

## ุงูุชุญูู ูู ุงูุตูุงุญูุงุช

ุงูุญููู ุงูุฌุฏูุฏุฉ **ูุทููุจุฉ ููุท** ุนูุฏูุง:
- `role = "5"` (ูุฏูุฑ ูููุน)

ูู ุฌููุน ุงูุฃุฏูุงุฑ ุงูุฃุฎุฑู:
- ุงูููู ุชุจูู `0` ุฃู `NULL`
- ุงูุญููู ูุง ุชุธูุฑ ูู ุงููููุฐุฌ

## ุงููููุงุช ุงููุนุฏูุฉ/ุงููุถุงูุฉ

### ูุนุฏูุฉ:
1. โ `main/users.php` - ุชุญุฏูุซ ุดุงูู

### ูุถุงูุฉ:
1. โ `database/add_mine_contract_to_users.sql` - SQL Schema
2. โ `Projects/get_project_mines_ajax.php` - AJAX Endpoint
3. โ `Contracts/get_mine_contracts_ajax.php` - AJAX Endpoint
4. โ `main/README_USERS_UPDATE.md` - ูุฐุง ุงูููู

## ุงุฎุชุจุงุฑ ุงููุธุงู

### 1. ุชูููุฐ SQL:
```bash
# ูู phpMyAdmin
1. ุงูุชุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช equipation_manage
2. ุงุฐูุจ ูุชุจููุจ SQL
3. ููุฐ ูุญุชูู ููู add_mine_contract_to_users.sql
```

### 2. ุงุฎุชุจุงุฑ ุงูุฅุถุงูุฉ:
```
1. ุงูุชุญ ุตูุญุฉ ุงููุณุชุฎุฏููู
2. ุงุถุบุท "ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ"
3. ุงุฎุชุฑ "ูุฏูุฑ ูููุน"
4. ุชุฃูุฏ ูู ุธููุฑ 3 ููุงุฆู ููุณุฏูุฉ
5. ุงุฎุชุฑ ูุดุฑูุน โ ุชุญูู ูู ุชุญููู ุงูููุงุฌู
6. ุงุฎุชุฑ ููุฌู โ ุชุญูู ูู ุชุญููู ุงูุนููุฏ
7. ุฃููู ุงูุจูุงูุงุช ูุงุญูุธ
```

### 3. ุงุฎุชุจุงุฑ ุงูุนุฑุถ:
```
1. ุชุญูู ูู ุธููุฑ ุจูุงูุงุช ุงููุดุฑูุน ูุงูููุฌู ูุงูุนูุฏ ูู ุงูุฌุฏูู
2. ุชุฃูุฏ ูู ุงูุฃููููุงุช ูุงูุชูุณูู
```

### 4. ุงุฎุชุจุงุฑ ุงูุชุนุฏูู:
```
1. ุงุถุบุท ุนูู ุฃููููุฉ ุงูุชุนุฏูู
2. ุชุฃูุฏ ูู ุชุญููู ุฌููุน ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ
3. ุบููุฑ ุงููุดุฑูุน โ ุชุญูู ูู ุฅุนุงุฏุฉ ุชุญููู ุงูููุงุฌู
4. ุบููุฑ ุงูููุฌู โ ุชุญูู ูู ุฅุนุงุฏุฉ ุชุญููู ุงูุนููุฏ
5. ุงุญูุธ ุงูุชุนุฏููุงุช
```

## ุงูุฃูุงู ูุงูุญูุงูุฉ

โ **SQL Injection:** ุฌููุน ุงููุฏุฎูุงุช ูุญููุฉ ุจู `mysqli_real_escape_string()` ู `intval()`
โ **Session Validation:** ุงูุชุญูู ูู ุงูุฌูุณุฉ ูู ุฌููุน AJAX endpoints
โ **Input Validation:** ุงูุชุญูู ูู ุงูููู ูุจู ุงูุญูุธ
โ **XSS Protection:** ุงุณุชุฎุฏุงู `htmlspecialchars()` ูู ุงูุนุฑุถ
โ **Required Fields:** ุงูุญููู ุงูุฌุฏูุฏุฉ ูุทููุจุฉ ููุท ููุฏูุฑ ุงููููุน

## ููุงุญุธุงุช ูููุฉ

1. **ุงูุชุฑุชูุจ ุงูุฅูุฒุงูู:** ูุดุฑูุน โ ููุฌู โ ุนูุฏ (ูุง ูููู ุชุฎุทู ุฃู ูููุง)
2. **ุงูุชุจุนูุฉ:** ุงูููุงุฌู ุชุชุจุน ุงููุดุฑูุนุ ูุงูุนููุฏ ุชุชุจุน ุงูููุฌู
3. **ุงูููู ุงูุงูุชุฑุงุถูุฉ:** ููุฃุฏูุงุฑ ุงูุฃุฎุฑู ุชุจูู ุงูููู 0
4. **ุงูุชูุงูููุฉ:** ุงููุธุงู ุงููุฏูู ูุนูู ุจุฏูู ุชุฃุซูุฑ ูููุณุชุฎุฏููู ุงูุญุงูููู

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงูููุงุฌู ูุง ุชุธูุฑ:
- ุชุญูู ูู console.log ูู Developer Tools (F12)
- ุชุฃูุฏ ูู ูุฌูุฏ ููุงุฌู ูููุดุฑูุน ุงููุฎุชุงุฑ
- ุชุญูู ูู ููู `get_project_mines_ajax.php`

### ุงูุนููุฏ ูุง ุชุธูุฑ:
- ุชุญูู ูู console.log
- ุชุฃูุฏ ูู ูุฌูุฏ ุนููุฏ ููููุฌู ุงููุฎุชุงุฑ
- ุชุญูู ูู ููู `get_mine_contracts_ajax.php`

### ุฎุทุฃ ูู ุงูุญูุธ:
- ุชุฃูุฏ ูู ุชูููุฐ SQL Schema ุฃููุงู
- ุชุญูู ูู ูุฌูุฏ ุงูุญููู `mine_id, contract_id` ูู ุฌุฏูู users

## ุงูุฏุนู ุงูููู

ูููุณุงุนุฏุฉ ุฃู ุงูุฅุจูุงุบ ุนู ูุดุงููุ ุชูุงุตู ูุน ูุฑูู ุงูุชุทููุฑ.

---
**ุขุฎุฑ ุชุญุฏูุซ:** 17 ูุจุฑุงูุฑ 2026
**ุงูุฅุตุฏุงุฑ:** 2.0
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุฅูุชุงุฌ
